---
title: "Sales Data for Staten Island"
author: "Thangam, Preeti, Ekaterina"
date: "March 1, 2017"
output: 
  html_document: 
    highlight: pygments
    keep_md: yes
    theme: readable
---
##Steps to create tidy data
###1. Read and check the raw data
```{r}
#read file with raw data
bk <- read.csv("Data/rollingsales_statenisland.csv",skip=4,header=TRUE)

## Check the data
head(bk)
summary(bk)
str(bk)
```
###2. Set all variable names to low case for easy use.
```{r}
names(bk) <- tolower(names(bk))
```
###3. We need to remove not actual sales. Sales with missing values.
```{r}
bk$sale.price.n <- as.numeric(gsub("[^[:digit:]]","", bk$sale.price))
bk$gross.sqft <- as.numeric(gsub("[^[:digit:]]","", bk$gross.square.feet))
bk$land.sqft <- as.numeric(gsub("[^[:digit:]]","", bk$land.square.feet))
bk$years.built <- as.numeric(as.character(bk$year.built))
```
###4. Then we create a set without missing values
```{r}
#create dataset with actual sales
cs=subset(bk,bk$sale.price.n>0&bk$gross.sqft>0&bk$land.sqft>0&bk$year.built>0)
```
###5. We need to remove columns that are a duplicat of our tidy columns
```{r}
cs$sale.price=NULL
cs$gross.square.feet=NULL
cs$land.square.feet=NULL
cs$year.built=NULL
```
###6. We need to check for not actual sales. 
####The best way to check it with data given is remove outliers from ratio sale price to gross square fit. It will remove 1$ sales or really weird sales.
```{r}
#checking for outliers and decaiding what to do with them 
#this code is taken from https://www.r-bloggers.com/identify-describe-plot-and-remove-the-outliers-from-the-dataset/
outlierKD <- function(dt, var) {
  var_name <- eval(substitute(var),eval(dt))
  na1 <- sum(is.na(var_name))
  m1 <- mean(var_name, na.rm = T)
  par(mfrow=c(2, 2), oma=c(0,0,3,0))
  boxplot(var_name, main="With outliers")
  hist(var_name, main="With outliers", xlab=NA, ylab=NA)
  outlier <- boxplot.stats(var_name)$out
  mo <- mean(outlier)
  var_name <- ifelse(var_name %in% outlier, NA, var_name)
  boxplot(var_name, main="Without outliers")
  hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
  title("Outlier Check", outer=TRUE)
  na2 <- sum(is.na(var_name))
  cat("Outliers identified:", na2 - na1, "n")
  cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "n")
  cat("Mean of the outliers:", round(mo, 2), "n")
  m2 <- mean(var_name, na.rm = T)
  cat("Mean without removing outliers:", round(m1, 2), "n")
  cat("Mean if we remove outliers:", round(m2, 2), "n")
  dt[as.character(substitute(var))] <- invisible(var_name)
  assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
  cat("Outliers successfully removed", "n")
  return(invisible(dt))
}



#apply this function until we get 0% proportion. This way we will get meaningful dataset.
cs$cs.pricePERsqft=cs$sale.price.n/cs$gross.sqft
outlierKD(cs,cs.pricePERsqft)
```
###7.Creating clean set without "NA" in place of outliers
```{r}
cleanset=subset(cs,!is.na(cs$cs.pricePERsqft))
```
###8. The last step is to save clean dataset
```{r}
#create csv with clean data
write.csv(cleanset,file='Data/CleanedSalesData.csv')
```
